version: "3.7"

services:
  web:
    build:
      context: ..
      dockerfile: docker/web/Dockerfile
    working_dir: /usr/src/app/src
    command: gunicorn core.wsgi:application --reload --bind 0.0.0.0:8000
    volumes:
      - ../src:/usr/src/app/src
      - static_volume:/usr/src/static
      - media_volume:/usr/src/media
      - cache_volume:/usr/src/cache
      - log_volume:/usr/src/log
    expose:
      - 8000
    env_file:
      - web/.env.dev.web
    depends_on:
      - db
      - azurite
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2048M

  worker:
    build:
      context: ..
      dockerfile: docker/worker/Dockerfile
    command: python orchestrator.py
    env_file:
      - worker/.env.dev.worker
    depends_on:
      - azurite
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 1024M

  worker-web:
    build:
      context: ..
      dockerfile: docker/worker-web/Dockerfile
    working_dir: /usr/src/app/src
    command: python manage.py run_web_jobs
    volumes:
      - ../src:/usr/src/app/src
      - static_volume:/usr/src/static
      - media_volume:/usr/src/media
      - cache_volume:/usr/src/cache
      - log_volume:/usr/src/log
    env_file:
      - web/.env.dev.web
    depends_on:
      - db
      - azurite
      - redis
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 1024M

  db:
    image: postgres
    restart: always
    volumes:
      - postgresql_data:/var/lib/postgresql/data
    ports:
      - 5432:5432
    env_file:
      - db/.env.dev.db
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 1024M

  nginx:
    build: ./nginx
    volumes:
      - static_volume:/usr/src/static
      - media_volume:/usr/src/media
    ports:
      - 8000:80
    depends_on:
      - web
    deploy:
      resources:
        limits:
          cpus: '0.20'
          memory: 250M

  azurite:
    image: mcr.microsoft.com/azure-storage/azurite
    hostname: azurite
    volumes:
      - azurite_volume:/data
    ports:
      - 20000:10000
      - 20001:10001
    deploy:
      resources:
        limits:
          cpus: '0.20'
          memory: 250M

  redis:
    image: redis:alpine
    ports:
      - 26379:6379
    volumes:
      - redis_volume:/data
    deploy:
      resources:
        limits:
          cpus: '0.20'
          memory: 50M      

volumes:
  postgresql_data:
  static_volume:
  media_volume:
  azurite_volume:
  cache_volume:
  log_volume:
  redis_volume:
